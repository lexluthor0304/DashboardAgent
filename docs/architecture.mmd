flowchart TB
  %% GitHub Mermaid parser is strict about unquoted punctuation in labels.
  %% Use quoted labels and \n for line breaks (avoid <br/>).

  %% ============ Client ============
  subgraph Client["Browser"]
    subgraph Web["Web App: React + Vite + TS"]
      Routes["Routes\n/edit/:id\n/d/:id"]
      Chat["ChatPanel\nmessage stream"]
      Canvas["CanvasGrid\nreact-grid-layout"]
      Cards["CardRenderer\nCardFrame"]
      Vega["VegaChart\nvega-embed"]
      RQ["React Query\nserver cache"]
      Store["zustand\nspec + history + runtime"]
      Theme["Theme system\nCSS vars + Vega config"]
    end
  end

  %% ============ API ============
  subgraph Server["API Service: Node"]
    Router["HTTP router"]
    Auth["Auth + share token\nhash verify"]
    Rate["Rate limit\nip + dashboardId"]
    Obs["Observability\nlogs + metrics + traces"]

    subgraph Agent["Agent orchestrator"]
      Prompt["Prompt builder\nintent + currentSpec + schema digest"]
      Tools["Skills/Tools registry\nzod IO contracts"]
      Validate["Validate + repair loop\nzod + invariants"]
      Patch["JSON Patch output\nRFC6902"]
    end

    subgraph Connectors["Connectors"]
      SFConn["Salesforce connector\njsforce"]
      OASConn["REST/GraphQL connector\nOpenAPI/Schema"]
    end

    subgraph Query["Query layer"]
      Model["Data model cache\ndescribe/schema projection"]
      DSL["Query DSL\ntyped + guarded"]
      Guard["Guardrails\nallowlists + limits"]
      Compile["Compiler\nDSL -> SOQL/HTTP"]
    end

    StoreSvc["Dashboard service\nspec CRUD"]
    DataSvc["Data service\nexecute DataRequest"]
  end

  %% ============ Storage ============
  subgraph Storage["Storage"]
    DB["DB\ndashboards + connectors\nSQLite or Postgres"]
    KV["Cache\nschema/rows optional"]
    Secrets["Secrets\nOAuth client + encryption key"]
  end

  %% ============ External ============
  subgraph External["External systems"]
    LLM["LLM provider\ntool calling"]
    Salesforce["Salesforce cloud"]
    APIs["Other APIs\nREST/GraphQL"]
  end

  %% ============ Client flows ============
  Routes --> Chat
  Routes --> Canvas
  Chat --> Store
  Canvas --> Store
  Store --> Cards
  Cards --> Vega
  Theme --> Vega
  RQ --> Cards

  %% ============ Client <-> Server ============
  Chat -->|POST /api/agent: message + currentSpec| Router
  Routes -->|GET /api/dashboards/:id token| Router
  Cards -->|GET /api/dashboards/:id/data: requestId + runtime| Router

  %% ============ Server request routing ============
  Router --> Rate --> Auth
  Router --> Obs
  Auth --> StoreSvc
  Auth --> DataSvc
  Auth --> Agent

  %% ============ Agent orchestration ============
  Agent --> Prompt --> Tools --> Validate --> Patch
  Patch -->|response| Router
  Agent -->|call| LLM
  LLM -->|JSON patch + dirtyAreas| Agent

  %% ============ Data execution ============
  DataSvc --> Model --> DB
  DataSvc --> DSL --> Guard --> Compile
  Compile --> SFConn --> Salesforce --> SFConn
  Compile --> OASConn --> APIs --> OASConn
  DataSvc -->|rows| Router

  %% ============ Persistence ============
  StoreSvc --> DB
  Agent --> DB
  SFConn --> DB
  Model --> KV
  DataSvc --> KV
  Secrets --> SFConn
  Secrets --> Agent
