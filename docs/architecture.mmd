flowchart TB
  %% ============ Client ============
  subgraph Client[Browser]
    subgraph Web[Web App (React + Vite + TS)]
      Routes[Routes<br/>/edit/:id<br/>/d/:id]
      Chat[ChatPanel<br/>message stream]
      Canvas[CanvasGrid<br/>react-grid-layout]
      Cards[CardRenderer<br/>CardFrame]
      Vega[VegaChart<br/>vega-embed]
      RQ[Server Cache<br/>@tanstack/react-query]
      Store[Client Store<br/>zustand<br/>spec + history + runtime]
      Theme[Theme System<br/>CSS vars + vega config]
    end
  end

  %% ============ API ============
  subgraph Server[API Service (Node)]
    Router[HTTP Router]
    Auth[Auth & Share Token<br/>hash verify]
    Rate[Rate Limit<br/>ip+dashboardId]
    Obs[Observability<br/>logs+metrics+traces]

    subgraph Agent[Agent Orchestrator]
      Prompt[Prompt Builder<br/>intent + currentSpec + schema digest]
      Tools[Skills/Tools Registry<br/>zod IO contracts]
      Validate[Validate & Repair Loop<br/>zod + invariants]
      Patch[JSON Patch Output<br/>RFC6902]
    end

    subgraph Connectors[Connectors]
      SFConn[Salesforce Connector<br/>jsforce]
      OASConn[REST/GraphQL Connector<br/>OpenAPI/Schema]
    end

    subgraph Query[Query Layer]
      Model[Data Model Cache<br/>describe/schema projection]
      DSL[Query DSL<br/>typed + guarded]
      Compile[Compiler<br/>DSL -> SOQL/HTTP]
      Guard[Guardrails<br/>field allowlist<br/>func allowlist<br/>limit/timeout]
    end

    StoreSvc[Dashboard Service<br/>spec CRUD]
    DataSvc[Data Service<br/>execute DataRequest]
  end

  %% ============ Storage ============
  subgraph Storage[Storage]
    DB[(DB: dashboards/connectors<br/>SQLite or Postgres)]
    KV[(Cache: schema/rows<br/>optional)]
    Secrets[[Secrets<br/>clientId/secret<br/>encryption key]]
  end

  %% ============ External ============
  subgraph External[External Systems]
    LLM[LLM Provider<br/>tool calling]
    Salesforce[Salesforce Cloud]
    APIs[Other APIs<br/>REST/GraphQL]
  end

  %% ============ Client flows ============
  Routes --> Chat
  Routes --> Canvas
  Chat --> Store
  Canvas --> Store
  Store --> Cards
  Cards --> Vega
  Theme --> Vega
  RQ --> Cards

  %% ============ Client <-> Server ============
  Chat -->|POST /api/agent<br/>message + currentSpec| Router
  Routes -->|GET /api/dashboards/:id?token=...| Router
  Cards -->|GET /api/dashboards/:id/data<br/>requestId + runtime overlay| Router

  %% ============ Server request routing ============
  Router --> Rate
  Rate --> Auth
  Auth --> StoreSvc
  Auth --> DataSvc
  Auth --> Agent
  Router --> Obs

  %% ============ Agent orchestration ============
  Agent --> Prompt
  Prompt -->|tool calls| Tools
  Tools --> Validate
  Validate --> Patch
  Agent -->|call| LLM
  LLM -->|JSON: patch + dirtyAreas| Agent
  Patch -->|response| Router

  %% ============ Data execution ============
  DataSvc --> Model
  Model --> DB
  DataSvc --> DSL
  DSL --> Guard
  Guard --> Compile
  Compile --> SFConn
  Compile --> OASConn
  SFConn -->|SOQL + OAuth refresh| Salesforce
  OASConn -->|HTTP calls| APIs
  Salesforce -->|rows| SFConn
  APIs -->|rows| OASConn
  DataSvc -->|rows| Router

  %% ============ Persistence ============
  StoreSvc --> DB
  Agent --> DB
  SFConn --> DB
  Model --> KV
  DataSvc --> KV
  Secrets --> SFConn
  Secrets --> Agent

